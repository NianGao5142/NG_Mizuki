---
interface Props {
	src: string;
}

const { src } = Astro.props;
const uniqueId = `word-viewer-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
---

<div class="word-viewer-container" id={uniqueId} data-src={src}>
	<div class="word-toolbar">
		<div class="toolbar-title">Word 文档预览</div>
		<a href={src} download class="download-btn">
			<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
				<polyline points="7 10 12 15 17 10"></polyline>
				<line x1="12" y1="15" x2="12" y2="3"></line>
			</svg>
			下载文档
		</a>
	</div>
	<div class="word-content-wrapper">
		<div class="loading-indicator">加载中...</div>
		<div class="word-content"></div>
	</div>
</div>

<script is:inline>
	(function() {
		function initWordViewer(container) {
			var docSrc = container.dataset.src;
			var wordContent = container.querySelector('.word-content');
			var loading = container.querySelector('.loading-indicator');

			if (!docSrc) {
				console.error('Source URL not found');
				loading.innerHTML = '<div class="error-message"><p>加载文档失败</p><p class="error-detail">未找到文档路径</p></div>';
				return;
			}

			wordContent.innerHTML = '';
			loading.style.display = 'block';
			loading.innerHTML = '加载中...';

			if (typeof mammoth === 'undefined') {
				var script = document.createElement('script');
				script.src = 'https://cdn.jsdelivr.net/npm/mammoth@1.11.0/mammoth.browser.min.js';
				script.onload = function() {
					loadDocument(docSrc, wordContent, loading);
				};
				script.onerror = function() {
					loading.innerHTML = '<div class="error-message"><p>加载文档失败</p><p class="error-detail">无法加载文档查看器</p></div>';
				};
				document.head.appendChild(script);
			} else {
				loadDocument(docSrc, wordContent, loading);
			}
		}

		function loadDocument(docSrc, wordContent, loading) {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', docSrc, true);
			xhr.responseType = 'arraybuffer';
			xhr.onload = function() {
				if (xhr.status === 200) {
					var arrayBuffer = xhr.response;
					if (arrayBuffer && arrayBuffer.byteLength > 0) {
						mammoth.convertToHtml({ arrayBuffer: arrayBuffer })
							.then(function(result) {
								wordContent.innerHTML = result.value;
								loading.style.display = 'none';
								if (result.messages.length > 0) {
									console.warn('Mammoth messages:', result.messages);
								}
							})
							.catch(function(err) {
								console.error('Error converting document:', err);
								loading.innerHTML = '<div class="error-message"><p>加载文档失败</p><p class="error-detail">' + err.message + '</p></div>';
							});
					} else {
						console.error('Empty or invalid response');
						loading.innerHTML = '<div class="error-message"><p>加载文档失败</p><p class="error-detail">文件内容为空</p></div>';
					}
				} else {
					console.error('HTTP error:', xhr.status);
					loading.innerHTML = '<div class="error-message"><p>加载文档失败</p><p class="error-detail">HTTP错误: ' + xhr.status + '</p></div>';
				}
			};
			xhr.onerror = function() {
				console.error('Network error');
				loading.innerHTML = '<div class="error-message"><p>加载文档失败</p><p class="error-detail">网络错误</p></div>';
			};
			xhr.send();
		}

		function initAllViewers() {
			var containers = document.querySelectorAll('.word-viewer-container');
			containers.forEach(function(container) {
				if (!container.dataset.initialized) {
					container.dataset.initialized = 'true';
					initWordViewer(container);
				}
			});
		}

		initAllViewers();

		document.addEventListener('astro:page-load', function() {
			initAllViewers();
		});
	})();
</script>

<style>
	.word-viewer-container {
		width: 100%;
		max-width: 1200px;
		margin: 0 auto;
		background: var(--card-bg);
		border-radius: 12px;
		overflow: hidden;
		border: 1px solid var(--line-divider);
	}

	.word-toolbar {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0.75rem 1rem;
		background: var(--card-bg);
		border-bottom: 1px solid var(--line-divider);
		flex-wrap: wrap;
		gap: 1rem;
	}

	.toolbar-title {
		font-size: 1rem;
		font-weight: 600;
		color: var(--text-primary);
	}

	.download-btn {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 1rem;
		background: var(--primary);
		color: white;
		text-decoration: none;
		border-radius: 6px;
		font-size: 0.875rem;
		font-weight: 500;
		transition: all 0.2s ease;
	}

	.download-btn:hover {
		opacity: 0.9;
		transform: translateY(-1px);
	}

	.word-content-wrapper {
		position: relative;
		min-height: 400px;
		padding: 2rem;
		background: var(--card-bg);
	}

	.word-content {
		line-height: 1.8;
		color: var(--text-primary);
	}

	.word-content p {
		margin-bottom: 1rem;
		text-align: justify;
	}

	.word-content h1,
	.word-content h2,
	.word-content h3,
	.word-content h4,
	.word-content h5,
	.word-content h6 {
		margin-top: 1.5rem;
		margin-bottom: 1rem;
		font-weight: 600;
		color: var(--text-primary);
	}

	.word-content h1 {
		font-size: 2rem;
		border-bottom: 2px solid var(--line-divider);
		padding-bottom: 0.5rem;
	}

	.word-content h2 {
		font-size: 1.5rem;
	}

	.word-content h3 {
		font-size: 1.25rem;
	}

	.word-content ul,
	.word-content ol {
		margin-bottom: 1rem;
		padding-left: 2rem;
	}

	.word-content li {
		margin-bottom: 0.5rem;
	}

	.word-content blockquote {
		margin: 1rem 0;
		padding: 0.5rem 1rem;
		border-left: 4px solid var(--primary);
		background: var(--card-bg);
		color: var(--text-muted);
	}

	.word-content code {
		padding: 0.2rem 0.4rem;
		background: var(--codeblock-bg);
		border-radius: 4px;
		font-family: 'JetBrains Mono Variable', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
			'Liberation Mono', 'Courier New', monospace;
		font-size: 0.875rem;
	}

	.word-content pre {
		margin: 1rem 0;
		padding: 1rem;
		background: var(--codeblock-bg);
		border-radius: 8px;
		overflow-x: auto;
	}

	.word-content pre code {
		padding: 0;
		background: transparent;
	}

	.word-content table {
		width: 100%;
		margin: 1rem 0;
		border-collapse: collapse;
	}

	.word-content th,
	.word-content td {
		padding: 0.75rem;
		border: 1px solid var(--line-divider);
		text-align: left;
	}

	.word-content th {
		background: var(--card-bg);
		font-weight: 600;
	}

	.word-content img {
		max-width: 100%;
		height: auto;
		margin: 1rem 0;
		border-radius: 8px;
	}

	.word-content a {
		color: var(--primary);
		text-decoration: none;
	}

	.word-content a:hover {
		text-decoration: underline;
	}

	.loading-indicator {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		padding: 1rem 2rem;
		background: var(--card-bg);
		border-radius: 8px;
		font-size: 0.875rem;
		color: var(--text-muted);
	}

	.error-message {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
		padding: 2rem;
		text-align: center;
	}

	.error-message p {
		margin: 0;
		color: var(--text-muted);
	}

	.error-detail {
		font-size: 0.875rem;
		color: var(--text-muted);
		opacity: 0.8;
	}

	@media (max-width: 640px) {
		.word-toolbar {
			flex-direction: column;
			align-items: flex-start;
		}

		.word-content-wrapper {
			padding: 1rem;
		}

		.word-content h1 {
			font-size: 1.5rem;
		}

		.word-content h2 {
			font-size: 1.25rem;
		}
	}
</style>

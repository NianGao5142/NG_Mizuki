name: Content Sync

on:
    repository_dispatch:
        types: [trigger-sync-from-gitee]

jobs:
    sync-content:
        runs-on: ubuntu-latest
        env:
            CONTENT_REPO_URL: https://gitee.com/niangao5142/mizuki-content.git
            CONTENT_DIR: ./content

        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  persist-credentials: true

            # 先安装 pnpm，然后再设置 Node.js 缓存
            - name: Install pnpm
              run: npm install -g pnpm

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm" # 现在 pnpm 已经安装，可以正确缓存了

            - name: Install dependencies
              run: pnpm install

            - name: Sync content
              run: pnpm run sync-content

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add .
                  if ! git diff --cached --quiet; then
                    git commit -m "Sync content from Gitee [$(date +'%Y-%m-%d %H:%M:%S')]"
                    git push
                    echo "✅ Changes pushed"
                  else
                    echo "ℹ️ No changes to commit"
                  fi


name: Content Sync

on:
    repository_dispatch:
        types: [trigger-sync-from-gitee]

jobs:
    sync-content:
        runs-on: ubuntu-latest
        env:
            CONTENT_REPO_URL: https://gitee.com/niangao5142/mizuki-content.git
            CONTENT_DIR: ./content

        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  persist-credentials: true

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install

            - name: Sync content
              run: pnpm run sync-content

            - name: Commit and push changes
              id: commit
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add .
                  if ! git diff --cached --quiet; then
                    git commit -m "Sync content from Gitee [$(date +'%Y-%m-%d %H:%M:%S')]"
                    git push
                    echo "changes_pushed=true" >> $GITHUB_OUTPUT
                    echo "âœ… Changes pushed"
                  else
                    echo "changes_pushed=false" >> $GITHUB_OUTPUT
                    echo "â„¹ï¸ No changes to commit"
                  fi

            # ğŸ‘‡ æ–°å¢ï¼šä»…å½“æœ‰å†…å®¹æ›´æ–°å¹¶æ¨é€åï¼Œæ‰è§¦å‘æ„å»º
            - name: Trigger CI Build (if changes pushed)
              if: steps.commit.outputs.changes_pushed == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'CI',
                        ref: 'master'  // ç¡®ä¿ä¸ä½ çš„é»˜è®¤åˆ†æ”¯ä¸€è‡´
                      });

